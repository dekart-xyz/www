<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=https://dekart.xyz/main.0adecde0ea212779cfeee12ea91ca3417744f2d70d72d170668819e973deca356159fe66caf47a745aabbf27d0ddda9ab5530c5621a61ba19cc5cedccd1add2a.css integrity="sha512-Ct7N4OohJ3nP7uEuqRyjQXdE8tcNctFwZogZ6XPeyjVhWf5myvR6dFqrvyfQ3dqatVMMViGmG6Gcxc7czRrdKg==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Compare and optimize BigQuery and Snowflake performance on GIS queries. Part 2. - Dekart</title><meta name=description content="Compare BigQuery and Snowflake on GIS query performance. Explore execution times, costs, and efficiency in a Geometry-in-Polygon use case with real-world data from Overture Maps"><link rel=canonical href=https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./dekart-map.png"><meta name=twitter:title content="Compare and optimize BigQuery and Snowflake performance on GIS queries. Part 2."><meta name=twitter:description content="Compare BigQuery and Snowflake on GIS query performance. Explore execution times, costs, and efficiency in a Geometry-in-Polygon use case with real-world data from Overture Maps"><meta name=twitter:creator content="@delfrrr"><meta property="og:title" content="Compare and optimize BigQuery and Snowflake performance on GIS queries. Part 2."><meta property="og:description" content="Compare BigQuery and Snowflake on GIS query performance. Explore execution times, costs, and efficiency in a Geometry-in-Polygon use case with real-world data from Overture Maps"><meta property="og:type" content="article"><meta property="og:url" content="https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./"><meta property="og:image" content="https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./dekart-map.png"><meta property="article:published_time" content="2024-12-10T05:59:51+00:00"><meta property="article:modified_time" content="2025-08-14T13:50:42+02:00"><meta property="og:site_name" content="Dekart"><meta property="og:locale" content="en_US"><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://dekart.xyz/apple-icon.png><link rel=icon type=image/png sizes=32x32 href=https://dekart.xyz/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://dekart.xyz/favicon-16x16.png><link rel=manifest href=https://dekart.xyz/site.webmanifest><script defer data-domain=dekart.xyz src=https://plausible.io/js/script.tagged-events.js></script></head><body><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label>
<a class="navbar-brand order-1 order-md-0 mr-auto" href=https://dekart.xyz/>Dekart</a><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=http://github.com/dekart-xyz/dekart><svg width="24" height="24" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M512 0C229.12.0.0 229.12.0 512c0 226.56 146.56 417.92 350.08 485.76 25.6 4.48 35.2-10.88 35.2-24.32.0-12.16-.64-52.48-.64-95.36-128.64 23.68-161.92-31.36-172.16-60.16-5.76-14.72-30.72-60.16-52.48-72.32-17.92-9.6-43.52-33.28-.64-33.92 40.32-.64 69.12 37.12 78.72 52.48 46.08 77.44 119.68 55.68 149.12 42.24 4.48-33.28 17.92-55.68 32.64-68.48-113.92-12.8-232.96-56.96-232.96-252.8.0-55.68 19.84-101.76 52.48-137.6-5.12-12.8-23.04-65.28 5.12-135.68.0.0 42.88-13.44 140.8 52.48 40.96-11.52 84.48-17.28 128-17.28s87.04 5.76 128 17.28c97.92-66.56 140.8-52.48 140.8-52.48 28.16 70.4 10.24 122.88 5.12 135.68 32.64 35.84 52.48 81.28 52.48 137.6.0 196.48-119.68 240-233.6 252.8 18.56 16 34.56 46.72 34.56 94.72.0 68.48-.64 123.52-.64 140.8.0 13.44 9.6 29.44 35.2 24.32C877.44 929.92 1024 737.92 1024 512 1024 229.12 794.88.0 512 0z" fill="#1b1f23"/></svg><span class="ml-2 sr-only">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav mr-auto order-5 order-md-2"><li class=nav-item><div id=suggestions class="shadow bg-white rounded"></div><a class="nav-link text-nowrap" href=https://dekart.xyz/cloud>Pricing</a></li><li class=nav-item><div id=suggestions class="shadow bg-white rounded"></div><a class="nav-link text-nowrap" href=https://dekart.xyz/docs/about/overture-maps-examples/>Examples</a></li><li class=nav-item><div id=suggestions class="shadow bg-white rounded"></div><a class="nav-link text-nowrap" href=https://dekart.xyz/docs/>Docs</a></li><li class=nav-item><div id=suggestions class="shadow bg-white rounded"></div><a class="nav-link text-nowrap" href=https://github.com/dekart-xyz/dekart>GitHub</a></li></ul><div class="break order-6 d-md-none"></div><ul class="navbar-nav navbar-login flex-grow-1 order-7 order-md-3 justify-content-end"><li class=nav-item><a class="nav-link text-nowrap" href="https://cloud.dekart.xyz/?ref=login" target=_blank rel="noopener noreferrer">Login</a></li><li class=nav-item><a class="btn btn-outline-primary" href="https://cloud.dekart.xyz/?ref=create-workspace" role=button>Create Free Workspace</a></li></ul></div></div></header><div class="wrap container" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"><article><div class=blog-header><h1>Compare and optimize BigQuery and Snowflake performance on GIS queries. Part 2.</h1><p><small>by <a class="stretched-link position-relative" href=https://dekart.xyz/contributors/vladi/>Vladi</a>&nbsp;&dash;&nbsp;<strong>5&nbsp;min read</strong></small><p></div><p class=lead>Geometry-in-Polygon Query with dynamic geometry.</p><p>This second post in the series compares performances of GIS queries between Snowflake. In a previous post, I <a href=/blog/compare-bigquery-and-snowflake-performance-on-gis-queries./>tested Geometry-in-Polygon Query with constant geometry</a>, showing that without Enterprise-only Snowflake Search Optimization, BigQuery significantly outperforms Snowflake due to spatial clustering.</p><p>However, how often do we see constant geometry in real-life pipelines? In my experience, geometry in most cases comes from another dataset.</p><h2 id=get-all-the-roads-in-berlin--spatial-join>Get all the roads in Berlin â€“ spatial join.</h2><p>This practical example covers common geometry in polygons scenarios. But this time I query boundary geometry from one dataset and use it to filter data in the other dataset.</p><figure><img class="img-fluid lazyload" data-sizes=auto src=https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./dekart-map_hucea5424ddd1607a54789ef9f477e8a3a_1287285_20x0_resize_box_3.png data-srcset="https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./dekart-map_hucea5424ddd1607a54789ef9f477e8a3a_1287285_2048x0_resize_box_3.png 2048w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./dekart-map_hucea5424ddd1607a54789ef9f477e8a3a_1287285_1600x0_resize_box_3.png 1600w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./dekart-map_hucea5424ddd1607a54789ef9f477e8a3a_1287285_1024x0_resize_box_3.png 1024w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./dekart-map_hucea5424ddd1607a54789ef9f477e8a3a_1287285_512x0_resize_box_3.png 512w" width=2442 height=1828><noscript><img class=img-fluid sizes=100vw srcset="https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./dekart-map_hucea5424ddd1607a54789ef9f477e8a3a_1287285_2048x0_resize_box_3.png 2048w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./dekart-map_hucea5424ddd1607a54789ef9f477e8a3a_1287285_1600x0_resize_box_3.png 1600w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./dekart-map_hucea5424ddd1607a54789ef9f477e8a3a_1287285_1024x0_resize_box_3.png 1024w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./dekart-map_hucea5424ddd1607a54789ef9f477e8a3a_1287285_512x0_resize_box_3.png 512w" src=https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./dekart-map.png width=2442 height=1828></noscript></figure><p class=view-on-map><a href="https://cloud.dekart.xyz/reports/d1c4414b-fd81-4dba-bb06-4dfdd618c8e0/source?ref=dekart-xyz-view-map" target=_blank class="btn btn-outline-primary btn-sm">View interactive map</a></p><p>BigQuery SQL</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=n>berlin_boundary</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>geometry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>bigquery</span><span class=o>-</span><span class=k>public</span><span class=o>-</span><span class=k>data</span><span class=p>.</span><span class=n>overture_maps</span><span class=p>.</span><span class=n>division_area</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=k>LOWER</span><span class=p>(</span><span class=k>names</span><span class=p>.</span><span class=k>primary</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;berlin&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>AND</span><span class=w> </span><span class=n>country</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;DE&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>geometry</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=k>class</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>subtype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>bigquery</span><span class=o>-</span><span class=k>public</span><span class=o>-</span><span class=k>data</span><span class=p>.</span><span class=n>overture_maps</span><span class=p>.</span><span class=n>segment</span><span class=o>`</span><span class=w> </span><span class=n>s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>berlin_boundary</span><span class=w> </span><span class=n>b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>ON</span><span class=w> </span><span class=n>ST_CONTAINS</span><span class=p>(</span><span class=n>b</span><span class=p>.</span><span class=n>geometry</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>geometry</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>subtype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;road&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>AND</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=k>class</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;primary&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;secondary&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;tertiary&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p class=playground-link><a href='https://cloud.dekart.xyz/reports/d1c4414b-fd81-4dba-bb06-4dfdd618c8e0/source?ref=dekart-xyz-open-editor' target=_blank class="btn btn-outline-primary btn-sm">Open query in editor</a></p><p>Snowflake SQL</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=n>berlin_boundary</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>geometry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>OVERTURE_MAPS__DIVISIONS</span><span class=p>.</span><span class=n>CARTO</span><span class=p>.</span><span class=n>DIVISION_AREA</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=k>LOWER</span><span class=p>(</span><span class=k>names</span><span class=p>:</span><span class=k>primary</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;berlin&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>AND</span><span class=w> </span><span class=n>country</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;DE&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>geometry</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=k>class</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>subtype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>OVERTURE_MAPS__TRANSPORTATION</span><span class=p>.</span><span class=n>CARTO</span><span class=p>.</span><span class=n>SEGMENT</span><span class=w> </span><span class=n>s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>berlin_boundary</span><span class=w> </span><span class=n>b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>ON</span><span class=w> </span><span class=n>ST_CONTAINS</span><span class=p>(</span><span class=n>b</span><span class=p>.</span><span class=n>geometry</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>geometry</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>subtype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;road&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>AND</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=k>class</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;primary&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;secondary&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;tertiary&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p class=playground-link><a href='https://cloud.dekart.xyz/reports/d1c4414b-fd81-4dba-bb06-4dfdd618c8e0/source?ref=dekart-xyz-open-editor' target=_blank class="btn btn-outline-primary btn-sm">Open query in editor</a></p><h3 id=first-results>First results</h3><table class=table><thead><tr><th>Query/db</th><th>Duration</th><th>Bytes Scanned</th><th>Cost</th></tr></thead><tbody><tr><td>BigQuery</td><td>3 seconds</td><td>86.81 GB</td><td>$0.424</td></tr><tr><td>Snowflake</td><td>1 minute 51 seconds</td><td>82.53GB</td><td>$0.080</td></tr></tbody></table><h3 id=query-plans>Query Plans</h3><figure><img class="img-fluid lazyload" data-sizes=auto src=https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./Snowflake-BigQuery-query-plans_hu8fab6b5ca83bb0c5ef9a402573780024_197186_20x0_resize_box_3.png data-srcset="https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./Snowflake-BigQuery-query-plans_hu8fab6b5ca83bb0c5ef9a402573780024_197186_2048x0_resize_box_3.png 2048w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./Snowflake-BigQuery-query-plans_hu8fab6b5ca83bb0c5ef9a402573780024_197186_1600x0_resize_box_3.png 1600w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./Snowflake-BigQuery-query-plans_hu8fab6b5ca83bb0c5ef9a402573780024_197186_1024x0_resize_box_3.png 1024w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./Snowflake-BigQuery-query-plans_hu8fab6b5ca83bb0c5ef9a402573780024_197186_512x0_resize_box_3.png 512w" width=1876 height=1066><noscript><img class=img-fluid sizes=100vw srcset="https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./Snowflake-BigQuery-query-plans_hu8fab6b5ca83bb0c5ef9a402573780024_197186_2048x0_resize_box_3.png 2048w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./Snowflake-BigQuery-query-plans_hu8fab6b5ca83bb0c5ef9a402573780024_197186_1600x0_resize_box_3.png 1600w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./Snowflake-BigQuery-query-plans_hu8fab6b5ca83bb0c5ef9a402573780024_197186_1024x0_resize_box_3.png 1024w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./Snowflake-BigQuery-query-plans_hu8fab6b5ca83bb0c5ef9a402573780024_197186_512x0_resize_box_3.png 512w" src=https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./Snowflake-BigQuery-query-plans.png width=1876 height=1066></noscript></figure><h2 id=first-observations>First observations</h2><ul><li>Both BigQuery and Snowflake perform full-table scans.</li><li>BigQuery, being highly parallel, completes query execution much faster, however at a higher cost.</li><li>Snowflake takes longer to complete but at a lower cost.</li></ul><h2 id=why-does-bigquery-perform-a-full-scan>Why does BigQuery perform a full scan?</h2><p>In the previous example, with static geometry, BigQuery was pruning partitions very efficiently using spatial clustering. However, here, the planner decides to perform a join instead.</p><p>BigQuery commonly uses two joining types:</p><ol><li>Broadcast join: Used when joining a large table to a small table. The small table is sent to each slot, processing the large table.</li><li>Hash join: Used when joining two large tables. BigQuery uses hash and shuffle operations to move matching keys to the same slot for a local join.</li></ol><p>Given a small amount of data returned from the first query and a small amount of data shuffled (moved between nodes), BigQuery likely used broadcast join in this case. A small result of the first query is sent to each slot processing a large Segment table, leading to fast execution but a full table scan.</p><h2 id=can-we-help-bigquery-planner-to-avoid-joining>Can we help BigQuery planner to avoid joining?</h2><p>Yes, with some hints from the planner, I was able to avoid join and decrease Total Slot Time from 32 min 16 sec to 16 min 48 sec.</p><p>Here Iâ€™m trying to give the planner all the hints.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=n>berlin_boundary</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>geometry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>bigquery</span><span class=o>-</span><span class=k>public</span><span class=o>-</span><span class=k>data</span><span class=p>.</span><span class=n>overture_maps</span><span class=p>.</span><span class=n>division_area</span><span class=o>`</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=k>LOWER</span><span class=p>(</span><span class=k>names</span><span class=p>.</span><span class=k>primary</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;berlin&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>AND</span><span class=w> </span><span class=n>country</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;DE&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>geometry</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=k>class</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>subtype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=o>`</span><span class=n>bigquery</span><span class=o>-</span><span class=k>public</span><span class=o>-</span><span class=k>data</span><span class=p>.</span><span class=n>overture_maps</span><span class=p>.</span><span class=n>segment</span><span class=o>`</span><span class=w> </span><span class=n>s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>subtype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;road&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>AND</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=k>class</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;primary&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;secondary&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;tertiary&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>AND</span><span class=w> </span><span class=n>ST_CONTAINS</span><span class=p>((</span><span class=k>select</span><span class=w> </span><span class=n>geometry</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>berlin_boundary</span><span class=w> </span><span class=k>limit</span><span class=w> </span><span class=mi>1</span><span class=p>),</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>geometry</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p class=playground-link><a href='https://cloud.dekart.xyz/reports/d1c4414b-fd81-4dba-bb06-4dfdd618c8e0/source?ref=dekart-xyz-open-editor' target=_blank class="btn btn-outline-primary btn-sm">Open query in editor</a></p><p>And indeed, no join in this case</p><figure><img class="img-fluid lazyload" data-sizes=auto src=https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./bigQuery-plan_hu88c217fea570a4202a0c0af147f89825_85268_20x0_resize_box_3.png data-srcset="https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./bigQuery-plan_hu88c217fea570a4202a0c0af147f89825_85268_2048x0_resize_box_3.png 2048w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./bigQuery-plan_hu88c217fea570a4202a0c0af147f89825_85268_1600x0_resize_box_3.png 1600w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./bigQuery-plan_hu88c217fea570a4202a0c0af147f89825_85268_1024x0_resize_box_3.png 1024w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./bigQuery-plan_hu88c217fea570a4202a0c0af147f89825_85268_512x0_resize_box_3.png 512w" width=730 height=910><noscript><img class=img-fluid sizes=100vw srcset="https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./bigQuery-plan_hu88c217fea570a4202a0c0af147f89825_85268_2048x0_resize_box_3.png 2048w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./bigQuery-plan_hu88c217fea570a4202a0c0af147f89825_85268_1600x0_resize_box_3.png 1600w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./bigQuery-plan_hu88c217fea570a4202a0c0af147f89825_85268_1024x0_resize_box_3.png 1024w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./bigQuery-plan_hu88c217fea570a4202a0c0af147f89825_85268_512x0_resize_box_3.png 512w" src=https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./bigQuery-plan.png width=730 height=910></noscript></figure><p>However, the query performs a full scan anyway. It looks like BigQuery did not utilize spatial clustering in this case. I did not find a way to make this query cheaper.</p><p>Iâ€™m aware about <a href=https://mentin.medium.com/divide-the-query-to-improve-cost-and-performance-df310a502a07>Michael Entin post how to split it to run cheap</a>. But I think in real-life scenarios with queries having many CTEs performing this SQL optimization, it will be too hard.</p><h2 id=can-we-help-snowflake-planner-to-avoid-expensive-joins>Can we help Snowflake planner to avoid expensive joins?</h2><p>Yes. In the first query, while filtering applied before GeoJoin, it did not reduce the number of records and apparently GeoJoin was performed against the full dataset, also spilling 11Gb on the disc.</p><p>Letâ€™s try now to give the planner some hints:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>WITH</span><span class=w> </span><span class=n>berlin_boundary</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>geometry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>OVERTURE_MAPS__DIVISIONS</span><span class=p>.</span><span class=n>CARTO</span><span class=p>.</span><span class=n>DIVISION_AREA</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=k>LOWER</span><span class=p>(</span><span class=k>names</span><span class=p>:</span><span class=k>primary</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;berlin&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=k>AND</span><span class=w> </span><span class=n>country</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;DE&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>LIMIT</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>geometry</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=k>class</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>subtype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>OVERTURE_MAPS__TRANSPORTATION</span><span class=p>.</span><span class=n>CARTO</span><span class=p>.</span><span class=n>SEGMENT</span><span class=w> </span><span class=n>s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>subtype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;road&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>AND</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=k>class</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;primary&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;secondary&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;tertiary&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>AND</span><span class=w> </span><span class=n>ST_CONTAINS</span><span class=p>((</span><span class=k>SELECT</span><span class=w> </span><span class=n>geometry</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>berlin_boundary</span><span class=p>),</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>geometry</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p class=playground-link><a href='https://cloud.dekart.xyz/reports/d1c4414b-fd81-4dba-bb06-4dfdd618c8e0/source?ref=dekart-xyz-open-editor' target=_blank class="btn btn-outline-primary btn-sm">Open query in editor</a></p><p>Query plan looks very different.</p><figure><img class="img-fluid lazyload" data-sizes=auto src=https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./snowflake-query-plan_hu7fb9fb137dca9185596f96b358986daf_105671_20x0_resize_box_3.png data-srcset="https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./snowflake-query-plan_hu7fb9fb137dca9185596f96b358986daf_105671_2048x0_resize_box_3.png 2048w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./snowflake-query-plan_hu7fb9fb137dca9185596f96b358986daf_105671_1600x0_resize_box_3.png 1600w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./snowflake-query-plan_hu7fb9fb137dca9185596f96b358986daf_105671_1024x0_resize_box_3.png 1024w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./snowflake-query-plan_hu7fb9fb137dca9185596f96b358986daf_105671_512x0_resize_box_3.png 512w" width=1648 height=1438><noscript><img class=img-fluid sizes=100vw srcset="https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./snowflake-query-plan_hu7fb9fb137dca9185596f96b358986daf_105671_2048x0_resize_box_3.png 2048w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./snowflake-query-plan_hu7fb9fb137dca9185596f96b358986daf_105671_1600x0_resize_box_3.png 1600w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./snowflake-query-plan_hu7fb9fb137dca9185596f96b358986daf_105671_1024x0_resize_box_3.png 1024w,https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./snowflake-query-plan_hu7fb9fb137dca9185596f96b358986daf_105671_512x0_resize_box_3.png 512w" src=https://dekart.xyz/blog/compare-and-optimize-bigquery-and-snowflake-performance-on-gis-queries.-part-2./snowflake-query-plan.png width=1648 height=1438></noscript></figure><p>Now Snowflake seems to apply filters more effectively and reduce the amount of table scans to 63.61GB and reduce execution time.</p><h2 id=can-we-get-execution-faster-with-a-larger-snowflake-warehouse>Can we get execution faster with a larger Snowflake warehouse?</h2><p>Yes, with a Medium (4x cost of XS) warehouse size, we were able to reduce query execution time to 20s. While the query runs faster, itâ€™s not 4x faster, so the cost is also higher.</p><h2 id=final-results>Final results</h2><table class=table><thead><tr><th>Query/db</th><th>Duration</th><th>Bites Scanned</th><th>Cost</th></tr></thead><tbody><tr><td>BigQuery</td><td>3 seconds</td><td>86.81 GB</td><td>$0.424</td></tr><tr><td>BigQuery optimized SQL</td><td>2 seconds</td><td>86.81 GB</td><td>$0.424</td></tr><tr><td>Snowflake</td><td>1 minute 51 seconds</td><td>82.53GB</td><td>$0.080</td></tr><tr><td>Snowflake optimized SQL</td><td>59s</td><td>765.81MB + 63.61GB</td><td>$0.043</td></tr><tr><td>Snowflake optimized SQL and Medium data warehouse size</td><td>20s</td><td>765.81MB + 63.61GB</td><td>$0.05777</td></tr></tbody></table><h1 id=key-insights>Key Insights</h1><ul><li>BigQuery can skip spatial clustering in complex scenarios, leading to costly full table scans.</li><li>BigQuery is impressively fast, but bytes scanned couldnâ€™t be reduced without splitting query; slot time was halved with query optimization.</li><li>Snowflake without hints scanned the entire dataset; optimized query cut time and data processed by 50%.</li><li>Snowflakeâ€™s XS warehouse is cost-efficient but slower; larger warehouses trade cost for speed.</li></ul><p>Short summary â€“ BigQuery is 10x faster, and Snowflake is 10x cheaper.</p><h2 id=what-is-next>What is next?</h2><p>In my next article, Iâ€™ll test Nearest Neighbor Search and Buffer Analysis, diving deeper into GIS performance on BigQuery and Snowflake.</p><p>Until then, explore my curated collection of SQL examples for creating maps with free public datasets on both platforms.</p><p>ðŸ‘‰ <a href=/docs/about/overture-maps-examples/>Find the examples here</a></p></article></div></div></div></div><footer class="footer text-muted"><div class=container><div class=col-16><ul class=list-inline><li class=list-inline-item>ðŸ›Ÿ <a href=https://slack.dekart.xyz/ target=_blank>Ask in Slack</a></li><li class=list-inline-item><a href=/legal/>Legal</a></li><li class=list-inline-item><a href=/carto/>Lightweight alternative to CARTO</a></li><li class=list-inline-item><a href=/docs/about/overture-maps-examples/>Overture Maps Examples</a></li></ul></div></div></footer><script src=https://dekart.xyz/main.6aedabf29b1e9276b2cecddc8ad7aa10bc927a3bee04aa5d5671088a8af6a2a939fd5e8c8a1de6ffc40607e5478a5e47644959bd7fad3807ef443d60ee5d8263.js integrity="sha512-au2r8pseknayzs3citeqELySejvuBKpdVnEIior2oqk5/V6Mih3m/8QGB+VHil5HZElZvX+tOAfvRD1g7l2CYw==" crossorigin=anonymous defer></script>
<script src=https://dekart.xyz/index.min.077437e5cffa3f57bc9f397a0c26486d2e8033d2ff8708153f357823577e00fe4950d536995f4d3a52afbee1bec1986adfd39f0fa8d7055786691fbf476f1983.js integrity="sha512-B3Q35c/6P1e8nzl6DCZIbS6AM9L/hwgVPzV4I1d+AP5JUNU2mV9NOlKvvuG+wZhq39OfD6jXBVeGaR+/R28Zgw==" crossorigin=anonymous defer></script></body></html>