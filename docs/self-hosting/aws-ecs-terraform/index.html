<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=stylesheet href=https://dekart.xyz/main.37b2b0f21b90d83d81aac97619004942bcfaea27f42d29621d573b9592c7e69da5dbffb22b52471aeccb6489936a237cb6c2fbaa3212474feeb4f89483338f73.css integrity="sha512-N7Kw8huQ2D2Bqsl2GQBJQrz66if0LSliHVc7lZLH5p2l2/+yK1JHGuzLZImTaiN8tsL7qjISR0/utPiUgzOPcw==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Amazon ECS - Dekart</title><meta name=description content="Example of deploying Dekart to Amazon Elastic Container Service (ECS) with Terraform."><link rel=canonical href=https://dekart.xyz/docs/self-hosting/aws-ecs-terraform/><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://dekart.xyz/dekart-social-preview-0-16.png"><meta name=twitter:title content="Amazon ECS"><meta name=twitter:description content="Example of deploying Dekart to Amazon Elastic Container Service (ECS) with Terraform."><meta name=twitter:creator content="@delfrrr"><meta property="og:title" content="Amazon ECS"><meta property="og:description" content="Example of deploying Dekart to Amazon Elastic Container Service (ECS) with Terraform."><meta property="og:type" content="article"><meta property="og:url" content="https://dekart.xyz/docs/self-hosting/aws-ecs-terraform/"><meta property="og:image" content="https://dekart.xyz/dekart-social-preview-0-16.png"><meta property="article:modified_time" content="2024-10-11T08:56:32+01:00"><meta property="og:site_name" content="Dekart"><meta property="og:locale" content="en_US"><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://dekart.xyz/apple-icon.png><link rel=icon type=image/png sizes=32x32 href=https://dekart.xyz/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://dekart.xyz/favicon-16x16.png><link rel=manifest href=https://dekart.xyz/site.webmanifest><script defer data-domain=dekart.xyz src=https://plausible.io/js/script.tagged-events.js></script></head><body><div class="header-bar fixed-top"></div><header class="navbar fixed-top navbar-expand-md navbar-light"><div class=container><input class="menu-btn order-0" type=checkbox id=menu-btn>
<label class="menu-icon d-md-none" for=menu-btn><span class=navicon></span></label>
<a class="navbar-brand order-1 order-md-0 mr-auto" href=https://dekart.xyz/>Dekart</a><ul class="navbar-nav social-nav order-3 order-md-5"><li class=nav-item><a class=nav-link href=http://github.com/dekart-xyz/dekart><svg width="24" height="24" viewBox="0 0 1024 1024" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M512 0C229.12.0.0 229.12.0 512c0 226.56 146.56 417.92 350.08 485.76 25.6 4.48 35.2-10.88 35.2-24.32.0-12.16-.64-52.48-.64-95.36-128.64 23.68-161.92-31.36-172.16-60.16-5.76-14.72-30.72-60.16-52.48-72.32-17.92-9.6-43.52-33.28-.64-33.92 40.32-.64 69.12 37.12 78.72 52.48 46.08 77.44 119.68 55.68 149.12 42.24 4.48-33.28 17.92-55.68 32.64-68.48-113.92-12.8-232.96-56.96-232.96-252.8.0-55.68 19.84-101.76 52.48-137.6-5.12-12.8-23.04-65.28 5.12-135.68.0.0 42.88-13.44 140.8 52.48 40.96-11.52 84.48-17.28 128-17.28s87.04 5.76 128 17.28c97.92-66.56 140.8-52.48 140.8-52.48 28.16 70.4 10.24 122.88 5.12 135.68 32.64 35.84 52.48 81.28 52.48 137.6.0 196.48-119.68 240-233.6 252.8 18.56 16 34.56 46.72 34.56 94.72.0 68.48-.64 123.52-.64 140.8.0 13.44 9.6 29.44 35.2 24.32C877.44 929.92 1024 737.92 1024 512 1024 229.12 794.88.0 512 0z" fill="#1b1f23"/></svg><span class="ml-2 sr-only">GitHub</span></a></li></ul><div class="collapse navbar-collapse order-4 order-md-1"><ul class="navbar-nav main-nav mr-auto order-5 order-md-2"><li class=nav-item><div id=suggestions class="shadow bg-white rounded"></div><a class="nav-link text-nowrap" href=https://cloud.dekart.xyz/>Login</a></li><li class=nav-item><div id=suggestions class="shadow bg-white rounded"></div><a class="nav-link text-nowrap" href=https://dekart.xyz/cloud>Pricing</a></li><li class=nav-item><div id=suggestions class="shadow bg-white rounded"></div><a class="nav-link text-nowrap" href=https://dekart.xyz/docs/about/playground/>Playground</a></li><li class="nav-item active"><div id=suggestions class="shadow bg-white rounded"></div><a class="nav-link text-nowrap" href=https://dekart.xyz/docs/>Docs</a></li><li class=nav-item><div id=suggestions class="shadow bg-white rounded"></div><a class="nav-link text-nowrap" href=https://github.com/dekart-xyz/dekart>GitHub</a></li><li class=nav-item><div id=suggestions class="shadow bg-white rounded"></div><a class="nav-link text-nowrap" href=https://slack.dekart.xyz>Slack</a></li></ul><div class="break order-6 d-md-none"></div><form class="navbar-form flex-grow-1 order-7 order-md-3"><input id=userinput class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded"></div></form></div></div></header><div class="wrap container" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar"><nav class=docs-links aria-label="Main navigation"><h3>About</h3><ul class=list-unstyled><li><a class=docs-link href=https://dekart.xyz/docs/about/kepler-gl-map-examples/>Kepler.gl maps examples</a></li><li><a class=docs-link href=https://dekart.xyz/docs/about/overture-maps-examples/>Overture Maps Examples</a></li><li><a class=docs-link href=https://dekart.xyz/docs/about/snowflake-kepler-gl-examples/>Snowflake Kepler.gl Examples</a></li><li><a class=docs-link href=https://dekart.xyz/docs/about/playground/>BigQuery Playground</a></li><li><a class=docs-link href=https://dekart.xyz/docs/about/screencast/>Dekart Screencast</a></li><li><a class=docs-link href=https://dekart.xyz/docs/about/your-datasets/>Query Private Datasets</a></li></ul><h3>Snowpark</h3><ul class=list-unstyled><li><a class=docs-link href=https://dekart.xyz/docs/snowflake-snowpark/about/>Dekart Snowpark Application</a></li></ul><h3>Configuration</h3><ul class=list-unstyled><li><a class=docs-link href=https://dekart.xyz/docs/configuration/environment-variables/>Environment Variables</a></li></ul><h3>Dekart Cloud</h3><ul class=list-unstyled><li><a class=docs-link href=https://dekart.xyz/docs/cloud/cloud-security-faq/>Security Considerations</a></li></ul><h3>Self-Hosting</h3><ul class=list-unstyled><li><a class=docs-link href=https://dekart.xyz/docs/self-hosting/app-engine/>Google App Engine</a></li><li><a class="docs-link active" href=https://dekart.xyz/docs/self-hosting/aws-ecs-terraform/>Amazon ECS</a></li><li><a class=docs-link href=https://dekart.xyz/docs/self-hosting/docker/>Docker</a></li><li><a class=docs-link href=https://dekart.xyz/docs/self-hosting/docker-compose/>Docker Compose</a></li><li><a class=docs-link href=https://dekart.xyz/docs/self-hosting/upgrade/>Upgrade to new version</a></li></ul><h3>Contributing</h3><ul class=list-unstyled><li><a class=docs-link href=https://dekart.xyz/docs/contributing/architecture-overview/>Architecture</a></li><li><a class=docs-link href=https://dekart.xyz/docs/contributing/build-from-source/>Build from Source</a></li></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#resources>Resources</a></li><li><a href=#setup-with-terraform>Setup with Terraform</a><ul><li><a href=#basics>Basics</a></li><li><a href=#network>Network</a></li><li><a href=#security-groups>Security Groups</a></li><li><a href=#s3-bucket>S3 bucket</a></li><li><a href=#roles>Roles</a></li><li><a href=#rds>RDS</a></li><li><a href=#load-balancer>Load Balancer</a></li><li><a href=#ecs>ECS</a></li></ul></li><li><a href=#complete-example>Complete example</a></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9 mx-xl-auto"><h1>Amazon ECS</h1><p class=lead></p><h2 id=prerequisites>Prerequisites<a href=#prerequisites class=anchor aria-hidden=true>#</a></h2><ul><li>AWS Credentials and Terraform installed</li><li>Route 53 zone where Dekart will be hosted in subdomains</li><li>Mapbox Token</li><li>Athena Catalog, <a href=https://aws.amazon.com/blogs/big-data/querying-openstreetmap-with-amazon-athena/ target=_blank>example adding OpenStreetMap</a></li><li>Cognito User Pool, <a href=https://beabetterdev.com/2021/08/16/how-to-add-google-social-sign-on-to-your-amazon-cognito-user-pool/ target=_blank>example with Cognito and Google SSO</a></li></ul><h2 id=resources>Resources<a href=#resources class=anchor aria-hidden=true>#</a></h2><p>Resources created in this guide</p><ul><li>network configuration (VPC, public and private subnets)</li><li>security groups</li><li>roles</li><li>RDS db instance</li><li>S3 bucket (for query storage and results cache)</li><li>load balancer including HTTPS and SSO with Cognito</li><li>ECS cluster, service, and task running on FARGATE</li></ul><h2 id=setup-with-terraform>Setup with Terraform<a href=#setup-with-terraform class=anchor aria-hidden=true>#</a></h2><h3 id=basics>Basics<a href=#basics class=anchor aria-hidden=true>#</a></h3><p>Before we can start talking to an AWS account, we have to set up the Terraform provider:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=nx>terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>required_providers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>aws</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>source</span>  = <span class=s2>&#34;hashicorp/aws&#34;</span>
</span></span><span class=line><span class=cl>      <span class=na>version</span> = <span class=s2>&#34;~&gt; 4.16&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=na>required_version</span> = <span class=s2>&#34;&gt;= 1.2.0&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>
</span></span></span><span class=line><span class=cl><span class=kr>provider</span> <span class=s2>&#34;aws&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>region</span> = <span class=nb>var</span><span class=p>.</span><span class=nx>region</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This is an example, so no terraform backend configuration.</p><h3 id=network>Network<a href=#network class=anchor aria-hidden=true>#</a></h3><p>Here we will set up as an example VPC with public and private networks in 2 availability zones. This setup following best practices described in <a href=https://aws.amazon.com/de/blogs/compute/task-networking-in-aws-fargate/ target=_blank>Task Networking in AWS Fargate</a>. Note that in the private subnet, outbound traffic has to go through a NAT gateway. AWS charges a considerable cost for NAT per hour, plus traffic. Dekart considerable amount of traffics in form of query results. Instead, we keep tasks in the public subnet and only the RDS instance in the private subnet. This setup does not require NAT configuration.</p><p>Example VPC setup:</p><pre tabindex=0><code>resource &#34;aws_vpc&#34; &#34;main&#34; {
  cidr_block = &#34;172.31.0.0/16&#34;
}

resource &#34;aws_internet_gateway&#34; &#34;main&#34; {
  vpc_id = aws_vpc.main.id
}

data &#34;aws_availability_zones&#34; &#34;available&#34; {
  state = &#34;available&#34;
}
</code></pre><p>Public and private subnets:</p><pre tabindex=0><code>resource &#34;aws_subnet&#34; &#34;private&#34; {
  vpc_id            = aws_vpc.main.id
  cidr_block        = element([&#34;172.31.0.0/24&#34;, &#34;172.31.1.0/24&#34;], count.index)
  availability_zone = element(data.aws_availability_zones.available.names, count.index)
  count             = 2
}

resource &#34;aws_subnet&#34; &#34;public&#34; {
  vpc_id            = aws_vpc.main.id
  cidr_block        = element([&#34;172.31.2.0/24&#34;, &#34;172.31.3.0/24&#34;], count.index)
  availability_zone = element(data.aws_availability_zones.available.names, count.index)
  count             = 2
}
</code></pre><p>Route public subnet via internet gateway:</p><pre tabindex=0><code>resource &#34;aws_route_table&#34; &#34;public&#34; {
  vpc_id = aws_vpc.main.id
}

resource &#34;aws_route&#34; &#34;public&#34; {
  route_table_id         = aws_route_table.public.id
  destination_cidr_block = &#34;0.0.0.0/0&#34;
  gateway_id             = aws_internet_gateway.main.id
}

resource &#34;aws_route_table_association&#34; &#34;public&#34; {
  count          = 2
  subnet_id      = element(aws_subnet.public.*.id, count.index)
  route_table_id = aws_route_table.public.id
}
</code></pre><h3 id=security-groups>Security Groups<a href=#security-groups class=anchor aria-hidden=true>#</a></h3><p>Private security groups will let ECS Task, RDS db instance and Load Balancer to connect to each other. We also allow outbound traffic, so Docker images can be fetched.</p><pre tabindex=0><code># let the ecs, rds and alb to connect to each other
resource &#34;aws_security_group&#34; &#34;dekart_private&#34; {
  name   = &#34;${var.dekart_deployment_name}-private&#34;
  vpc_id = aws_vpc.main.id

  # connection within the group
  ingress {
    from_port = 0
    to_port   = 0
    protocol  = &#34;-1&#34;
    self      = true
  }

  # connecting to outside
  egress {
    from_port        = 0
    to_port          = 0
    protocol         = &#34;-1&#34;
    cidr_blocks      = [&#34;0.0.0.0/0&#34;]
    ipv6_cidr_blocks = [&#34;::/0&#34;]
  }

  # https://github.com/hashicorp/terraform-provider-aws/issues/265
  lifecycle { create_before_destroy = true }
}
</code></pre><p>Note the lifecycle rule necessary for security groups because of known issue <a href=https://github.com/hashicorp/terraform-provider-aws/issues/265 target=_blank>Destroying Security Groups Takes Forever with Attached SG</a></p><p>Load balancer security group allows inbound traffic.</p><pre tabindex=0><code># allow connections to load balancer
resource &#34;aws_security_group&#34; &#34;dekart_alb&#34; {
  name   = &#34;${var.dekart_deployment_name}-alb&#34;
  vpc_id = aws_vpc.main.id

  ingress {
    protocol         = &#34;tcp&#34;
    from_port        = 80
    to_port          = 80
    cidr_blocks      = [&#34;0.0.0.0/0&#34;]
    ipv6_cidr_blocks = [&#34;::/0&#34;]
  }

  ingress {
    protocol         = &#34;tcp&#34;
    from_port        = 443
    to_port          = 443
    cidr_blocks      = [&#34;0.0.0.0/0&#34;]
    ipv6_cidr_blocks = [&#34;::/0&#34;]
  }

  lifecycle { create_before_destroy = true }
}
</code></pre><h3 id=s3-bucket>S3 bucket<a href=#s3-bucket class=anchor aria-hidden=true>#</a></h3><p>Bucket to store queries and cache query results</p><pre tabindex=0><code>resource &#34;aws_s3_bucket&#34; &#34;dekart_output&#34; {
  bucket = &#34;${var.dekart_deployment_name}-output&#34;
}
</code></pre><h3 id=roles>Roles<a href=#roles class=anchor aria-hidden=true>#</a></h3><p>Ecs task role requires access to output S3 bucket and sufficient access to run Athena jobs.</p><pre tabindex=0><code>resource &#34;aws_iam_role&#34; &#34;dekart_task&#34; {
  name = &#34;${var.dekart_deployment_name}-task&#34;
  assume_role_policy = jsonencode({
    Version = &#34;2012-10-17&#34;
    Statement = [
      {
        Effect = &#34;Allow&#34;,
        Action = &#34;sts:AssumeRole&#34;,
        Sid    = &#34;&#34;,
        Principal = {
          Service = &#34;ecs-tasks.amazonaws.com&#34;
        }
      },
    ]
  })
  inline_policy {
    name = &#34;${var.dekart_deployment_name}-task-policy&#34;
    policy = jsonencode({
      Version = &#34;2012-10-17&#34;,
      Statement = [
        {
          Effect = &#34;Allow&#34;,
          Action = [
            &#34;s3:*&#34;
          ]
          Resource = [
            aws_s3_bucket.dekart_output.arn,
            &#34;${aws_s3_bucket.dekart_output.arn}/*&#34;,
          ]
        },
        {
          Effect = &#34;Allow&#34;,
          Action = [
            &#34;athena:CancelQueryExecution&#34;,
            &#34;athena:Get*&#34;,
            &#34;athena:StartQueryExecution&#34;,
            &#34;athena:StopQueryExecution&#34;,
            &#34;glue:Get*&#34;,
          ],
          Resource = [
            &#34;*&#34;
          ]
        },
        {
          &#34;Effect&#34; : &#34;Allow&#34;,
          &#34;Action&#34; : [
            &#34;s3:ListBucket&#34;,
            &#34;s3:GetBucketLocation&#34;,
            &#34;s3:ListAllMyBuckets&#34;
          ],
          &#34;Resource&#34; : [
            &#34;*&#34;
          ]
        },
        {
          &#34;Effect&#34; : &#34;Allow&#34;,
          &#34;Action&#34; : [
            &#34;lakeformation:GetDataAccess&#34;
          ],
          &#34;Resource&#34; : [
            &#34;*&#34;
          ]
        },
        {
          &#34;Effect&#34; : &#34;Allow&#34;,
          &#34;Action&#34; : [
            &#34;s3:GetObject&#34;
          ],
          &#34;Resource&#34; : flatten([
            [for bucket in var.athena_s3_data_source : &#34;arn:aws:s3:::${bucket}&#34;]
          ])
        },
      ]
    })
  }
}
</code></pre><p>Ecs execution role:</p><pre tabindex=0><code>resource &#34;aws_iam_role&#34; &#34;dekart_execution&#34; {
  name = &#34;${var.dekart_deployment_name}-execution&#34;
  managed_policy_arns = [
    &#34;arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy&#34;,
  ]
  assume_role_policy = jsonencode({
    Version = &#34;2012-10-17&#34;
    Statement = [
      {
        Effect = &#34;Allow&#34;,
        Action = &#34;sts:AssumeRole&#34;,
        Sid    = &#34;&#34;,
        Principal = {
          Service = &#34;ecs-tasks.amazonaws.com&#34;
        }
      },
    ]
  })
}
</code></pre><h3 id=rds>RDS<a href=#rds class=anchor aria-hidden=true>#</a></h3><p>Generate password and store it in secret manager:</p><pre tabindex=0><code>resource &#34;random_password&#34; &#34;dekart_rds&#34; {
  length  = 16
  special = false
}

resource &#34;aws_secretsmanager_secret&#34; &#34;dekart_rds&#34; {
  name = &#34;${var.dekart_deployment_name}-rds&#34;
}

resource &#34;aws_secretsmanager_secret_version&#34; &#34;dekart_rds&#34; {
  secret_id     = aws_secretsmanager_secret.dekart_rds.id
  secret_string = random_password.dekart_rds.result
  lifecycle {
    ignore_changes = [
      secret_string
    ]
  }
}
</code></pre><p>Subnet group</p><pre tabindex=0><code>resource &#34;aws_db_subnet_group&#34; &#34;dekart_rds&#34; {
  name       = &#34;${var.dekart_deployment_name}-rds&#34;
  subnet_ids = aws_subnet.private.*.id
}
</code></pre><p>Example DB instance configuration. It does not follow all the best practices in terms to back up and protection from deletion.</p><pre tabindex=0><code>resource &#34;aws_db_instance&#34; &#34;dekart&#34; {
  identifier                  = var.dekart_deployment_name
  allocated_storage           = 20 # min size for gp2 storage_type type
  storage_type                = &#34;gp2&#34;
  engine                      = &#34;postgres&#34;
  engine_version              = &#34;14.1&#34;
  instance_class              = &#34;db.t3.micro&#34;
  db_name                     = var.dekart_rds_db_name
  username                    = var.dekart_rds_username
  password                    = aws_secretsmanager_secret_version.dekart_rds.secret_string
  allow_major_version_upgrade = false
  auto_minor_version_upgrade  = true
  port                        = 5432
  publicly_accessible         = false
  storage_encrypted           = true
  vpc_security_group_ids      = [aws_security_group.dekart_private.id]
  db_subnet_group_name        = aws_db_subnet_group.dekart_rds.name
  skip_final_snapshot         = true

  lifecycle {
    ignore_changes = [
      password
    ]
  }
}
</code></pre><h3 id=load-balancer>Load Balancer<a href=#load-balancer class=anchor aria-hidden=true>#</a></h3><p>Create a load balancer and target group. In real configuration, you may use already existing balancer:</p><pre tabindex=0><code>resource &#34;aws_alb&#34; &#34;dekart&#34; {
  name               = var.dekart_deployment_name
  load_balancer_type = &#34;application&#34;
  security_groups    = [aws_security_group.dekart_private.id, aws_security_group.dekart_alb.id]
  subnets            = aws_subnet.public.*.id
}

resource &#34;aws_alb_target_group&#34; &#34;dekart&#34; {
  name        = var.dekart_deployment_name
  port        = &#34;8080&#34;
  protocol    = &#34;HTTP&#34;
  vpc_id      = aws_vpc.main.id
  target_type = &#34;ip&#34;
}
</code></pre><p>DNS zone record:</p><pre tabindex=0><code>data &#34;aws_route53_zone&#34; &#34;main&#34; {
  name = var.zone_name
}

resource &#34;aws_route53_record&#34; &#34;dekart&#34; {
  name    = &#34;${var.dekart_deployment_name}.${data.aws_route53_zone.main.name}&#34;
  zone_id = data.aws_route53_zone.main.zone_id
  type    = &#34;A&#34;

  alias {
    name                   = aws_alb.dekart.dns_name
    zone_id                = aws_alb.dekart.zone_id
    evaluate_target_health = false
  }
}
</code></pre><p>ACM certificate for HTTPS with validation over DNS</p><pre tabindex=0><code>resource &#34;aws_acm_certificate&#34; &#34;dekart&#34; {

  domain_name       = aws_route53_record.dekart.name
  validation_method = &#34;DNS&#34;

  lifecycle {
    create_before_destroy = true
  }
}

resource &#34;aws_route53_record&#34; &#34;dekart_certificate_validation&#34; {
  for_each = {
    for dvo in aws_acm_certificate.dekart.domain_validation_options : dvo.domain_name =&gt; {
      name   = dvo.resource_record_name
      record = dvo.resource_record_value
      type   = dvo.resource_record_type
    }
  }
  allow_overwrite = true
  name            = each.value.name
  records         = [each.value.record]
  ttl             = 60
  type            = each.value.type
  zone_id         = aws_route53_record.dekart.zone_id
}

resource &#34;aws_acm_certificate_validation&#34; &#34;dekart&#34; {
  certificate_arn         = aws_acm_certificate.dekart.arn
  validation_record_fqdns = [for record in aws_route53_record.dekart_certificate_validation : record.fqdn]
}
</code></pre><p>Listeners for HTTP and HTTPS requests:</p><pre tabindex=0><code>resource &#34;aws_alb_listener&#34; &#34;dekart_http&#34; {
  load_balancer_arn = aws_alb.dekart.arn
  port              = &#34;80&#34;
  protocol          = &#34;HTTP&#34;

  default_action {
    type = &#34;redirect&#34;

    redirect {
      port        = 443
      protocol    = &#34;HTTPS&#34;
      status_code = &#34;HTTP_301&#34;
    }
  }
}

resource &#34;aws_alb_listener&#34; &#34;dekart_https&#34; {
  load_balancer_arn = aws_alb.dekart.arn
  port              = 443
  protocol          = &#34;HTTPS&#34;

  ssl_policy      = &#34;ELBSecurityPolicy-2016-08&#34;
  certificate_arn = aws_acm_certificate.dekart.arn

  default_action {
    type             = &#34;forward&#34;
    target_group_arn = aws_alb_target_group.dekart.arn
  }
}
</code></pre><h4 id=cognito-authentication>Cognito authentication<a href=#cognito-authentication class=anchor aria-hidden=true>#</a></h4><p>Load balancer rule with Cognito authentication. For this configuration, you need to create a Cognito user pool. Check this example for user pool configuration <a href=https://beabetterdev.com/2021/08/16/how-to-add-google-social-sign-on-to-your-amazon-cognito-user-pool/>How to add Google Social Sign On To Your Amazon Cognito User Pool</a></p><pre tabindex=0><code>resource &#34;aws_alb_listener_rule&#34; &#34;dekart_listener_rule&#34; {

  listener_arn = aws_alb_listener.dekart_https.arn

  action {
    type = &#34;authenticate-cognito&#34;

    authenticate_cognito {
      scope               = &#34;email openid&#34;
      user_pool_arn       = var.user_pool_arn
      user_pool_client_id = var.user_pool_client_id
      user_pool_domain    = var.user_pool_domain
    }
  }

  action {
    type             = &#34;forward&#34;
    target_group_arn = aws_alb_target_group.dekart.arn
  }

  condition {
    path_pattern {
      values = [&#34;/*&#34;]
    }
  }
}
</code></pre><h3 id=ecs>ECS<a href=#ecs class=anchor aria-hidden=true>#</a></h3><p>Optional, Cloud Watch log group configuration</p><pre tabindex=0><code>resource &#34;aws_cloudwatch_log_group&#34; &#34;dekart&#34; {
  name              = var.dekart_deployment_name
  retention_in_days = 7
}
</code></pre><p>ECS task for Dekart. In this example, we configure Dekart to work with Amazon Athena. See <a href=/docs/configuration/environment-variables/>environment variables documentation</a> for details:</p><pre tabindex=0><code>resource &#34;aws_ecs_task_definition&#34; &#34;dekart&#34; {
  family                   = &#34;dekart&#34;
  requires_compatibilities = [&#34;FARGATE&#34;]
  network_mode             = &#34;awsvpc&#34;
  cpu                      = &#34;256&#34;
  memory                   = &#34;512&#34;
  task_role_arn            = aws_iam_role.dekart_task.arn
  execution_role_arn       = aws_iam_role.dekart_execution.arn
  container_definitions    = &lt;&lt;TASK_DEFINITION
[
    {
       &#34;name&#34;: &#34;${var.dekart_deployment_name}&#34;,
       &#34;image&#34;: &#34;dekartxyz/dekart:${var.dekart_version}&#34;,
       &#34;portmappings&#34;: [
          {
            &#34;hostport&#34;: 8080,
            &#34;protocol&#34;: &#34;tcp&#34;,
            &#34;containerport&#34;: 8080
          }
        ],
       &#34;environment&#34;: [
          {
             &#34;name&#34;: &#34;AWS_REGION&#34;,
             &#34;value&#34;: &#34;${var.region}&#34;
          },
          {
             &#34;name&#34;: &#34;DEKART_POSTGRES_HOST&#34;,
             &#34;value&#34;: &#34;${aws_db_instance.dekart.address}&#34;
          },
          {
             &#34;name&#34;: &#34;DEKART_POSTGRES_PORT&#34;,
             &#34;value&#34;: &#34;${aws_db_instance.dekart.port}&#34;
          },
          {
             &#34;name&#34;: &#34;DEKART_POSTGRES_DB&#34;,
             &#34;value&#34;: &#34;${aws_db_instance.dekart.db_name}&#34;
          },
          {
             &#34;name&#34;: &#34;DEKART_POSTGRES_USER&#34;,
             &#34;value&#34;: &#34;dekart&#34;
          },
          {
             &#34;name&#34;: &#34;DEKART_POSTGRES_PASSWORD&#34;,
             &#34;value&#34;: &#34;${aws_secretsmanager_secret_version.dekart_rds.secret_string}&#34;
          },
          {
             &#34;name&#34;: &#34;DEKART_STORAGE&#34;,
             &#34;value&#34;: &#34;S3&#34;
          },
          {
             &#34;name&#34;: &#34;DEKART_DATASOURCE&#34;,
             &#34;value&#34;: &#34;ATHENA&#34;
          },
          {
             &#34;name&#34;: &#34;DEKART_CLOUD_STORAGE_BUCKET&#34;,
             &#34;value&#34;: &#34;${aws_s3_bucket.dekart_output.id}&#34;
          },
          {
             &#34;name&#34;: &#34;DEKART_ATHENA_CATALOG&#34;,
             &#34;value&#34;: &#34;${var.athena_catalog}&#34;
          },
          {
             &#34;name&#34;: &#34;DEKART_ATHENA_S3_OUTPUT_LOCATION&#34;,
             &#34;value&#34;: &#34;${aws_s3_bucket.dekart_output.id}&#34;
          },
          {
             &#34;name&#34;: &#34;DEKART_MAPBOX_TOKEN&#34;,
             &#34;value&#34;: &#34;${var.mapbox_token}&#34;
          }
       ],
       &#34;logconfiguration&#34;: {
          &#34;logdriver&#34;: &#34;awslogs&#34;,
          &#34;secretoptions&#34;: null,
          &#34;options&#34;: {
             &#34;awslogs-group&#34;: &#34;${aws_cloudwatch_log_group.dekart.name}&#34;,
             &#34;awslogs-region&#34;: &#34;${var.region}&#34;,
             &#34;awslogs-stream-prefix&#34;: &#34;dekart&#34;
          }
       }
    }
 ]
   TASK_DEFINITION
}
</code></pre><p>ECS cluster configuration:</p><pre tabindex=0><code>resource &#34;aws_ecs_cluster&#34; &#34;dekart&#34; {
  name = var.dekart_deployment_name
}
</code></pre><p>Finally, ECS service configuration. For cost efficiency, we launch this service using FARGATE. Currently, Dekart does not support horizontal scaling, so we need to set <code>desired_count = 1</code>.</p><p>Because we avoid creating NAT and proxy query results through it, we need to put task in the public subnet. Task also needs a public IP address in order to make outbound requests like fetch docker image. However, as it is part of the private security group, inbound traffic is not allowed to the task. The only way to access it is via load balancer.</p><pre tabindex=0><code>resource &#34;aws_ecs_service&#34; &#34;dekart&#34; {
  name                 = var.dekart_deployment_name
  cluster              = aws_ecs_cluster.dekart.id
  task_definition      = &#34;${aws_ecs_task_definition.dekart.family}:${aws_ecs_task_definition.dekart.revision}&#34;
  desired_count        = 1 # important, dekart does not scale horizontally
  force_new_deployment = true
  launch_type          = &#34;FARGATE&#34;

  network_configuration {
    security_groups  = [aws_security_group.dekart_private.id]
    subnets          = aws_subnet.public.*.id
    assign_public_ip = true # it is necessarily to access Internet from task without NAT
  }

  load_balancer {
    target_group_arn = aws_alb_target_group.dekart.arn
    container_name   = var.dekart_deployment_name
    container_port   = 8080
  }
}
</code></pre><h2 id=complete-example>Complete example<a href=#complete-example class=anchor aria-hidden=true>#</a></h2><p>Here you can find <a href=https://github.com/dekart-xyz/dekart/tree/main/install/ecs target=_blank>complete example</a></p><p>To run it:</p><ul><li>create <code>./terraform.tfvars.json</code></li><li>define required variables, see <code>./variables.tf</code> for details</li><li>run <code>terraform apply</code></li></ul><p class=edit-page><a href=https://github.com/dekart-xyz/www/blob/main/content/docs/self-hosting/aws-ecs-terraform.md><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-edit-2"><path d="M17 3a2.828 2.828.0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Edit this page on GitHub</a></p><div class="docs-navigation d-flex justify-content-between"><a href=https://dekart.xyz/docs/self-hosting/app-engine/><div class="card my-1"><div class="card-body py-2">&larr; Google App Engine</div></div></a><a class=ml-auto href=https://dekart.xyz/docs/self-hosting/docker/><div class="card my-1"><div class="card-body py-2">Docker &rarr;</div></div></a></div></main></div></div></div><footer class="footer text-muted"><div class=container><div class=col-16><ul class=list-inline><li class=list-inline-item>✨ <a href=/cloud>Dekart Cloud</a></li><li class=list-inline-item><a href=/legal/notice>Legal Notice</a></li><li class=list-inline-item><a href=/legal/terms>Terms of Service</a></li><li class=list-inline-item><a href=/legal/privacy>Privacy Policy</a></li></ul></div></div></footer><script src=https://dekart.xyz/main.a6457e6b2c3744f9f5ecc18fb5779cbd59d6fdb9451e21e69ca5e0ba90c2520c99d83879f95a20979095c16a5b4eb59b9c0a7886dcba186e5d910cd5893f269b.js integrity="sha512-pkV+ayw3RPn17MGPtXecvVnW/blFHiHmnKXgupDCUgyZ2Dh5+Vogl5CVwWpbTrWbnAp4hty6GG5dkQzViT8mmw==" crossorigin=anonymous defer></script>
<script src=https://dekart.xyz/index.min.06228cdff3c7f7107b57176d83152c18e4bdc6e8f1b4b49a0b921bbb5a9c8865f058d90c8893af7e0ecc83629828437d57dc28debdd73d971a388bfa2a5ee74d.js integrity="sha512-BiKM3/PH9xB7VxdtgxUsGOS9xujxtLSaC5Ibu1qciGXwWNkMiJOvfg7Mg2KYKEN9V9wo3r3XPZcaOIv6Kl7nTQ==" crossorigin=anonymous defer></script></body></html>